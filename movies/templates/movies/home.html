{% extends 'movies/base.html' %}

{% block title %}Home | CinemaFlix{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
  .hover-opacity-100 { transition: opacity 0.3s; }
  .hover-opacity-100:hover { opacity: 1 !important; }
  .carousel-caption { background: rgba(0,0,0,0.5);}
</style>
{% endblock %}

{% block hero %}
<!-- HERO CAROUSEL -->
<div id="featuredCarousel" class="carousel slide mb-4 p-4" data-bs-ride="carousel">
  <div class="carousel-inner rounded-4">
    {% for movie in movies %}
    <div class="carousel-item {% if forloop.first %}active{% endif %} position-relative">
      {% if movie.is_new %}

          <div class="position-absolute top-0 start-0 m-2"><span class="badge bg-danger rounded-pill">NEW</span></div>

          {% endif %}
      {% if movie.poster %}
      <img src="{{ movie.poster.url }}" class="d-block w-100" alt="{{ movie.title }}" style="height: 400px; object-fit:cover;">
      {% else %}
      <div class="d-flex align-items-start justify-content-center bg-dark text-light" style="height:400px;">
        <h2>{{ movie.title }}</h2>
      </div>
      {% endif %}

      <div class="carousel-caption text-start p-4 rounded-4">
        <h3 class="fw-bold">{{ movie.title }}</h3>
        <p>{{ movie.description|truncatechars:50 }}</p>
        <p class="mb-1 small">{{ movie.genre }}</p>

            <span class="small"><i class="bi bi-clock me-1"></i><small>{{ movie.display_duration }}</small></span>
        <!-- Stars -->

          <div class="position-relative top-0 mb-2">

            <span class="badge text-warning">

              {% for star in movie.stars_list %}

                {% if star == 'full' %}<i class="bi bi-star-fill"></i>{% elif star == 'half' %}<i class="bi bi-star-half"></i>{% else %}<i class="bi bi-star"></i>{% endif %}

              {% endfor %}

              {{ movie.avg_rating|default:"N/A"|floatformat:1 }}
            </span>

          </div>
          <!-- NEW badge -->

          
        <a href="{% url 'movie_detail' movie.pk %}" class="btn btn-danger btn-sm">
          <i class="bi bi-play-fill me-1"></i> Watch Now
        </a>
      </div>
    </div>
    {% endfor %}
  </div>

  <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>
{% endblock %}

{% block content %}
<section>
  <div class="d-flex justify-content-between align-items-center p-3">
    <h3 class="text-light fw-bold"><i class="bi bi-compass text-success me-2"></i>Latest Movie</h3>
    <a href="{% url 'movie_list' %}" class="btn btn-dark btn-sm"><i class="bi bi-grid me-1"></i>View All</a>
  </div>

  {% if other_movies %}
  <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4 p-3">
    {% for movie in other_movies %}
    <div class="col" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'50' }}">
      <div class="card bg-black border border-secondary h-100">
        <div class="position-relative overflow-hidden rounded-top">
          {% if movie.poster %}
          <img src="{{ movie.poster.url }}" class="card-img-top" alt="{{ movie.title }}" style="height:280px; object-fit:cover;">
          {% else %}
          <div class="card-img-top bg-dark d-flex align-items-center justify-content-center" style="height:280px;">
            <i class="bi bi-film text-white fs-1"></i>
          </div>
          {% endif %}

          <!-- Overlay buttons -->
          <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center opacity-0 hover-opacity-100">
            <div class="text-center">
              <a href="{% url 'movie_detail' movie.pk %}" class="btn btn-danger mb-2"><i class="bi bi-play-fill"></i> Play</a>
              {% if user.is_authenticated %}
              <form action="{% url 'toggle_favorite' movie.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light btn-sm">
                  {% if movie.id in user_fav_ids %}
                  <i class="bi bi-heart-fill"></i>
                  {% else %}
                  <i class="bi bi-heart"></i>
                  {% endif %}
                </button>
              </form>
              {% endif %}
            </div>
          </div>

          <!-- Stars -->
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge bg-dark text-warning">
              {% for star in movie.stars_list %}
                {% if star == 'full' %}<i class="bi bi-star-fill"></i>{% elif star == 'half' %}<i class="bi bi-star-half"></i>{% else %}<i class="bi bi-star"></i>{% endif %}
              {% endfor %}
              {{ movie.avg_rating|default:"N/A"|floatformat:1 }}
            </span>
          </div>

          <!-- NEW badge -->
          {% if movie.is_new %}
          <div class="position-absolute top-0 start-0 m-2"><span class="badge bg-danger">NEW</span></div>
          {% endif %}
        </div>

        <div class="card-body p-2">
          <h6 class="card-title text-light mb-2">{{ movie.title|truncatechars:20 }}</h6>
          
          <div class="d-flex justify-content-between align-items-center small text-secondary">
            <p class="mb-1">{{ movie.genre }}</p>
            <span><i class="bi bi-clock me-1"></i>{{ movie.display_duration }}</span>
          </div>
        </div>

        <div class="card-footer bg-transparent border-top border-secondary py-1 align-items-center d-flex justify-content-center">
          <a href="{% url 'movie_detail' movie.pk %}" class="btn btn-outline-light btn-sm m-2">
            <i class="bi bi-info-circle me-1"></i>Details
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5 bg-black rounded border border-secondary">
    <i class="bi bi-film display-1 text-secondary mb-3"></i>
    <h4 class="text-secondary mb-2">No movies available</h4>
    <p class="text-muted mb-3">Start adding movies to your collection</p>
    <a href="{% url 'movie_list' %}" class="btn btn-danger"><i class="bi bi-plus-circle me-1"></i>Add Movies</a>
  </div>
  {% endif %}
</section>

<!-- ================= TRENDING / POPULAR MOVIES ================= -->
<section class="my-5">
  <div class="d-flex justify-content-between align-items-center p-3">
    <h2 class="text-light fw-bold"><i class="bi bi-fire text-danger me-2"></i>Top Rated</h2>
    <a href="{% url 'movie_list' %}" class="btn btn-outline-danger btn-sm"><i class="bi bi-grid me-1"></i>View All</a>
  </div>

  {% if trending_movies %}
  <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4 p-3">
    {% for movie in trending_movies %}
    <div class="col" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:'50' }}">
      <div class="card bg-black border border-secondary h-100">
        <div class="position-relative overflow-hidden rounded-top">
          {% if movie.poster %}
          <img src="{{ movie.poster.url }}" class="card-img-top" alt="{{ movie.title }}" style="height:280px; object-fit:cover;">
          {% else %}
          <div class="card-img-top bg-dark d-flex align-items-center justify-content-center" style="height:280px;">
            <i class="bi bi-film text-white fs-1"></i>
          </div>
          {% endif %}

          <!-- Stars & Favorite -->
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge bg-dark text-warning">
              {% for star in movie.stars_list %}
                {% if star == 'full' %}<i class="bi bi-star-fill"></i>{% elif star == 'half' %}<i class="bi bi-star-half"></i>{% else %}<i class="bi bi-star"></i>{% endif %}
              {% endfor %}
              {{ movie.avg_rating|default:"N/A"|floatformat:1 }}
            </span>
          </div>

          {% if movie.is_new %}
          <div class="position-absolute top-0 start-0 m-2"><span class="badge bg-danger">NEW</span></div>
          {% endif %}

          {% if user.is_authenticated %}
          <div class="position-absolute bottom-0 end-0 m-2">
            <form action="{% url 'toggle_favorite' movie.id %}" method="post" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-light btn-sm">
                {% if movie.id in user_fav_ids %}
                <i class="bi bi-heart-fill"></i>
                {% else %}
                <i class="bi bi-heart"></i>
                {% endif %}
              </button>
            </form>
          </div>
          {% endif %}
        </div>

        <div class="card-body p-2">
          <h6 class="card-title text-light mb-1">{{ movie.title|truncatechars:25 }}</h6>
          <p class="text-secondary small mb-1">{{ movie.genre }}</p>
        </div>

        <div class="card-footer bg-transparent border-top border-secondary py-1">
          <a href="{% url 'movie_detail' movie.pk %}" class="btn btn-outline-light btn-sm w-100">
            <i class="bi bi-info-circle me-1"></i>Details
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-secondary">No trending movies at the moment.</p>
  {% endif %}
</section>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init({ once: true });</script>
{% endblock %}
